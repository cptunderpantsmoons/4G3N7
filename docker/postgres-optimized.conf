# PostgreSQL Configuration for 4G3N7 Database Performance
# Place this file in your PostgreSQL data directory

# Memory Settings
shared_buffers = 256MB                    # 25% of RAM on dedicated server
effective_cache_size = 1GB               # 75% of RAM on dedicated server
work_mem = 4MB                           # Memory for internal sort operations and hash tables
maintenance_work_mem = 64MB              # Memory for maintenance operations (VACUUM, CREATE INDEX, etc.)

# Connection Settings
max_connections = 200                    # Maximum number of concurrent connections
superuser_reserved_connections = 3       # Reserved connections for superusers

# Write-Ahead Logging (WAL) for durability
wal_buffers = 16MB                       # WAL buffer size
checkpoint_completion_target = 0.9       # Spread out checkpoint I/O over more time
wal_writer_delay = 200ms                 # Delay between WAL writer flushes
commit_delay = 0                         # Microseconds between commit and flushing WAL to disk

# Query Planning
random_page_cost = 1.1                   # Optimized for SSD storage
effective_io_concurrency = 200           # Number of simultaneous I/O requests for SSDs

# Background Writer
bgwriter_delay = 200ms                   # Delay between background writer rounds
bgwriter_lru_maxpages = 100              # Max buffers to flush per round
bgwriter_lru_multiplier = 2.0            # Multiplier for buffers to flush

# Autovacuum Settings
autovacuum = on                          # Enable autovacuum
autovacuum_max_workers = 3               # Number of autovacuum workers
autovacuum_naptime = 30s                 # Time between autovacuum runs

# Logging Settings (comment out in production if performance is critical)
log_min_duration_statement = 1000        # Log queries that take longer than 1 second
log_checkpoints = on                     # Log checkpoints
log_connections = on                     # Log client connections
log_disconnections = on                  # Log client disconnections
log_lock_waits = on                      # Log lock wait times

# Performance Monitoring
track_activities = on                    # Track activity information
track_counts = on                        # Track row-level statistics
track_io_timing = on                     # Track I/O timing
track_functions = all                    # Track function call statistics

# pg_stat_statements extension
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# Statement Timeout (prevent runaway queries)
statement_timeout = 300000               # 5 minute timeout
idle_in_transaction_session_timeout = 60000  # Kill idle transactions after 1 minute

# Deadlock Settings
deadlock_timeout = 1s                    # Time to wait for deadlock detection

# Checkpoint Settings
checkpoint_timeout = 15min               # Time between automatic checkpoints
checkpoint_warning = 30s                 # Warning before checkpoint timeout

# Multi-Version Concurrency Control (MVCC)
old_snapshot_threshold = -1              # Disable old snapshot cleanup

# Locale Settings (optimized for performance)
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'

# Timezone
timezone = 'UTC'

# JIT Compilation (disable for OLTP workloads)
jit = off

# Parallel Query Settings
max_parallel_workers_per_gather = 2      # Limit parallel workers for OLTP
max_parallel_workers = 4                 # Total parallel workers

# Planner Settings
enable_seqscan = on                      # Enable sequential scans
enable_indexscan = on                    # Enable index scans
enable_bitmapscan = on                   # Enable bitmap scans
enable_hashagg = on                      # Enable hash aggregation
enable_hashjoin = on                     # Enable hash joins
enable_mergejoin = on                    # Enable merge joins
enable_nestloop = on                     # Enable nested loop joins

# Memory for sorting and hashing
temp_file_limit = 2GB                    # Limit temporary file space

# Maximum size of a single query result
max_stack_depth = 2MB                    # Maximum stack depth
max_locks_per_transaction = 64           # Maximum locks per transaction

# Virtual File Descriptors
max_files_per_process = 1000             # Maximum open files per process

# SSL Settings (enable if using SSL)
# ssl = on
# ssl_cert_file = '/var/lib/postgresql/server.crt'
# ssl_key_file = '/var/lib/postgresql/server.key'

# Listen Addresses
listen_addresses = '*'                   # Listen on all interfaces
port = 5432                              # Standard PostgreSQL port